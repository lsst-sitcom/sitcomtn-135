# Pipeline Tasks in the AOS Wavefront Estimation Pipeline

```{abstract}
Here we explain the Rubin Science Pipeline Tasks that make up the Active Optics System Wavefront Estimation Pipeline (WEP) and investigate timing and implementation of those tasks in a production environment.
```

## WEP Pipeline Tasks

The Wavefront Estimation Pipeline (WEP) is the code that will analyze defocal images and estimate the Rubin Observatory wavefront in terms of Zernike polynomials. The Rubin Active Optics System (AOS) will rely on these estimates to calculate the needed corrections to the optical system to maximize image quality. The pipeline runs as a set of Rubin Science Pipeline "Pipe Tasks". There are four sets of tasks that make up the pipeline of which the final three are developed by the Rubin AOS team and maintained on github at https://github.com/lsst-ts/ts_wep. The four jobs that the tasks perform are:

1. Instrument Signature Removal (ISR): This is performed on the raw images and the code for this task is developed by the Rubin DM team.
2. Catalog Generation
3. Postage Stamp Creation
4. Zernike Estimation

In this section we will describe the pipeline tasks that perform steps 2-4 in more detail.

### Catalog Generation

We have three main pipeline tasks that we can choose to use for catalog generation depending on our needs at the time.

1. **Generate Catalogs From WCS and Reference Catalogs**: We use the WCS supplied by the image and the reference catalogs available in the butler (e.g., Gaia) to run our source selection algorithms on catalog data and then identify the locations on the image with the WCS.
2. **Generate Catalogs From Direct Detection**: In the default mode for this task we convolve the image with a template defocused source and run source detection on the convolved image. We then run our source selection algorithms on the catalogs generated from this direct detection before saving a final set of sources to use for wavefront estimation. We anticipate that this mode will be most useful early in commissioning before an accurate pointing model is developed.
3. **Generate Catalogs From New WCS**: When running with this task we combine the two tasks above. We run an initial source detection directly on the image and use these sources to fit a new WCS on the image. We then create a catalog using the new WCS and reference catalogs as in the first task above.

In each of these catalog generation steps we take the initial sources that exist on the image and run our own source selection algorithms to select only sources that will be appropriate for wavefront estimation. For more information on our source selection algorithms as well as deblending options see [SITCOMTN-130](https://sitcomtn-130.lsst.io/).

### Postage Stamp Creation

This set of tasks all take in source catalogs generated by the previous catalog generation tasks and the post-ISR images and use them to cut out postage stamps of all the sources we want to use in wavefront estimation. When we load the post-ISR images we first perform background subtraction on the entire image before moving on to cut out postage stamps. This process occurs in two steps. We first cut out a larger section of the image around the source position given by the catalog. We then use a model template and convolve the stamp to recenter the stamp on the actual location of the source before cutting out a smaller postage stamp which is the size expected by the Zernike wavefront estimation task that follows. The recentering occurs because the actual location on the image for the source may be different than the catalog value especially if it was generated using the WCS and reference catalog. If this difference is too large we have a configuration that sets a maximum recentering distance and the recentering will not occur. The final stamp will be cut out in the original location and the stamp will be flagged in the task metadata as well as adding a warning message to the task log.

There are two separate tasks that perform the cut out step and they are different because of the properties of the specific wavefront sensors on the LSST Camera versus the science sensors on LSSTCam. The wavefront estimation currently implemented by the WEP requires pairs of intra-focal and extra-focal images to calculate the wavefront using the Transport of Intensity equation (TIE). The wavefront sensors on the LSST camera are offset from the science sensors by 1.5 mm with 4 half chips each in the extra-focal and intra-focal direction. Therefore, when using the wavefront sensors on LSSTCam all of the extra-focal and intra-focal images are taken in the same visit so we  run the full WEP on images from a single exposure. When we are running AOS during commissioning with the LSST Commissioning Camera (ComCam) or the science sensors on LSSTCam we will need to piston the camera away from focus in one direction and take an exposure before pistoning to the opposite side of focus and taking another exposure. This requires storing the postage stamps cut out from pairs of visits together when running the WEP since the Zernike estimation works on pairs of intra-focal and extra-focal images. As a result when running WEP on science sensors we use a donut visit pair table to specify which exposures should have stamps grouped under the same data ID (we use the visit ID for the extra-focal visit) in the butler. The pair table can be generated in three different ways:

1. **Manual**: Users can generate their own pair tables specifying which intra-focal exposures and which extra-focal exposures should be grouped together. They can then ingest the table into the butler themselves for use with the pipeline.
2. **Exposure Visit Info**: This method uses information stored in the `visitInfo` that accompanies each exposure in the butler and attempts to pair images automatically by finding images close in time, rotation and pointing location on the sky.
3. **Group ID**: When taking the exposures we can specify a `GROUPID` value for each image that will be stored in the headers and propogate into the dimensions that can be queried by the butler. This method groups exposures with the same group ID value together.

### Zernike Estimation

TIE Writeup: https://sitcomtn-111.lsst.io/

### Additional Resources

ts_analysis_notebooks

## WEP Timing

### Running as a pipeline from command line

The Active Optics System (AOS) will need to run completely between exposures during Rubin Observatory commissioning. With a little bit of time between exposures this gives us a time constraint of approximately 33 seconds to run the complete AOS including propogating corrections through to the optical system. Therefore, the WEP pipeline needs to run as quickly as possible preferably within about 25 seconds to leave time for the corrections to be made.

### Running inside Rapid Analysis


